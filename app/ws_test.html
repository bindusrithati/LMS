<!DOCTYPE html>
<html>
<head>
  <title>Mentor Student Chat</title>
</head>
<body>

<h3>Batch Chat</h3>
<p><b>Status:</b> <span id="status">Connecting...</span></p>

<input id="msg" placeholder="Type message" />
<button onclick="send()">Send</button>

<ul id="chat"></ul>

<script>
  let myUserId = null;
  let myRole = null;
  let myName = null;

  // üî¥ JWT TOKEN
  const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6NiwibmFtZSI6InN0cmluZyIsImVtYWlsIjoiYmluZHUxQGdtYWlsLmNvbSIsInJvbGUiOiJNZW50b3IiLCJwaG9uZV9udW1iZXIiOiJzdHJpdGd5bmciLCJleHAiOjE3NzAzNjk1MTF9.ZAfA-xVhxAGxEvadDJ6MICU1HxDBCeBugpDhhtOnclg";

  // üî¥ BATCH ID
  const batchId = 12;

  const ws = new WebSocket(
    `ws://127.0.0.1:8000/ws/chat/batch/${batchId}?token=${token}`
  );

  ws.onopen = () => {
    document.getElementById("status").innerText = "Connected ‚úÖ";
  };

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);

    // INIT
    if (data.type === "init") {
      myUserId = data.user_id;
      myRole = data.role;
      myName = data.name;
      return;
    }

    // USER LEFT
    if (data.type === "leave") {
      const li = document.createElement("li");
      li.innerText = `User ${data.user_id} left the chat`;
      document.getElementById("chat").appendChild(li);
      return;
    }

    // MESSAGE
    if (data.type === "message") {
      const li = document.createElement("li");

      if (data.user_id === myUserId) {
        li.innerText = `You (${myRole}): ${data.message}`;
      } else {
        li.innerText = `${data.name} (${data.role}): ${data.message}`;
      }

      document.getElementById("chat").appendChild(li);
    }
  };

  ws.onclose = () => {
    document.getElementById("status").innerText = "Disconnected ‚ùå";
  };

  function send() {
    const input = document.getElementById("msg");
    if (!input.value.trim()) return;

    ws.send(JSON.stringify({ message: input.value }));
    input.value = "";
  }
</script>

</body>
</html>
